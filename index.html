<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生數位簽到系統</title>
    <style>
        /* 基礎排版與容器 */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { max-width: 800px; width: 100%; margin: 20px 0; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; }
        h2 { color: #34495e; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 25px; }
        
        /* 導航列 */
        .nav-bar { text-align: center; margin-bottom: 20px; }
        .nav-bar button { 
            margin: 5px; padding: 10px 18px; border: none; 
            cursor: pointer; background-color: #ecf0f1; 
            color: #34495e; border-radius: 6px; 
            font-size: 1em; transition: background-color 0.3s, color 0.3s;
        }
        .nav-bar button.active { background-color: #3498db; color: white; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4); }
        .nav-bar button:hover:not(.active) { background-color: #bdc3c7; }

        /* 輸入與按鈕 */
        .page label { display: block; font-weight: bold; margin-top: 15px; margin-bottom: 5px; color: #34495e; }
        input, select { 
            padding: 12px; margin-bottom: 10px; border-radius: 6px; 
            border: 1px solid #ccc; width: 100%; box-sizing: border-box; 
            font-size: 1em;
        }
        button[type="submit"] { 
            background-color: #2ecc71; color: white; padding: 12px 20px; 
            margin-top: 15px; border: none; border-radius: 6px; 
            cursor: pointer; width: 100%; font-size: 1.1em;
            transition: background-color 0.3s;
        }
        button[type="submit"]:hover { background-color: #27ae60; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }

        /* 訊息區塊 */
        .message { padding: 15px; margin-top: 20px; border-radius: 6px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* 表格樣式 */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #ecf0f1; color: #34495e; }
        
        /* 規則標註樣式 */
        .invalid-checkin {
            background-color: #fce7e7; /* 淺紅色背景 */
            color: #cc0000;          /* 深紅色文字 */
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>學生數位簽到系統</h1>
    <div class="nav-bar">
        <button id="show-checkin-btn" class="active">學生簽到</button>
        <button id="show-student-query-btn">學生查詢</button>
        <button id="show-teacher-admin-btn">教師管理</button>
    </div>

    <div id="checkin-page" class="page">
        <h2>學生簽到</h2>
        <form id="checkin-form">
            <label for="week-select">選擇週次：</label>
            <select id="week-select" required></select>
            
            <label for="student-id-input">學號：</label>
            <input type="text" id="student-id-input" placeholder="請輸入學號" required>
            
            <button type="submit">確認簽到</button>
        </form>
        <div id="checkin-message" class="message" style="display: none;"></div>
    </div>

    <div id="student-query-page" class="page" style="display: none;">
        <h2>查詢個人簽到記錄</h2>
        <form id="student-query-form">
            <label for="query-student-id">學號：</label>
            <input type="text" id="query-student-id" placeholder="請輸入學號" required>
            <button type="submit">查詢記錄</button>
        </form>
        <div id="student-query-message" class="message" style="display: none;"></div>
        <div id="student-records-display"></div>
    </div>

    <div id="teacher-admin-page" class="page" style="display: none;">
        <h2>教師管理介面</h2>
        <form id="teacher-login-form">
            <label for="teacher-password">管理密碼：</label>
            <input type="password" id="teacher-password" placeholder="請輸入密碼" required>
            <button type="submit">登入並顯示記錄</button>
        </form>
        <div id="teacher-message" class="message" style="display: none;"></div>
        <div id="teacher-records-display"></div>
    </div>

</div>

<script>
    // ----------------------------------------------------------------------------------
    // **重要：替換成您最新部署 Apps Script 服務後得到的 URL**
    // ----------------------------------------------------------------------------------
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwyx1NW8ZEsoqlMH2pq2-4IVuYoHlm33dW8v2SyxS21M8P07KftPLBvkMI5GnuX03xC_w/exec'; 
    
    // --- 頁面元素與切換邏輯 ---
    const pages = {
        'checkin-page': document.getElementById('checkin-page'),
        'student-query-page': document.getElementById('student-query-page'),
        'teacher-admin-page': document.getElementById('teacher-admin-page')
    };
    const navButtons = {
        'show-checkin-btn': 'checkin-page',
        'show-student-query-btn': 'student-query-page',
        'show-teacher-admin-btn': 'teacher-admin-page'
    };

    function showPage(pageId) {
        for (let id in pages) {
            pages[id].style.display = (id === pageId) ? 'block' : 'none';
        }
        for (let btnId in navButtons) {
            document.getElementById(btnId).classList.toggle('active', navButtons[btnId] === pageId);
        }
    }

    // 導航按鈕事件
    document.getElementById('show-checkin-btn').addEventListener('click', () => showPage('checkin-page'));
    document.getElementById('show-student-query-btn').addEventListener('click', () => showPage('student-query-page'));
    document.getElementById('show-teacher-admin-btn').addEventListener('click', () => showPage('teacher-admin-page'));


    // --- 核心 Apps Script 通訊函數 ---
    async function callAppsScript(action, data = {}) {
        const messageDiv = data.messageDiv;
        if (messageDiv) {
             messageDiv.style.display = 'none';
             messageDiv.innerHTML = '';
        }

        // 包含 action 參數和所有數據
        const formData = new URLSearchParams({ action, ...data });

        try {
            const response = await fetch(APP_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            const result = await response.json();
            return result;

        } catch (e) {
            const msg = '連線錯誤，請檢查 Apps Script URL 或網路連線。';
            if (messageDiv) showMessage(messageDiv, msg, 'error');
            return { status: 'error', message: msg };
        }
    }
    
    // --- 輔助函數：顯示訊息 ---
    function showMessage(divElement, message, type) {
        divElement.className = `message ${type}`;
        divElement.innerHTML = message;
        divElement.style.display = 'block';
    }

    // --- [功能 1] 週次選單載入 ---
    async function loadWeekOptions() {
        const selectElement = document.getElementById('week-select');
        selectElement.innerHTML = '<option value="">載入中...</option>';
        selectElement.disabled = true;
        
        const result = await callAppsScript('getWeekOptions', { messageDiv: document.getElementById('checkin-message') });

        if (result.status === 'success') {
            selectElement.innerHTML = ''; // 清空載入中
            result.weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week.value;
                option.textContent = week.label;
                selectElement.appendChild(option);
            });
            // 預設選中最後一週
            selectElement.value = result.weeks[result.weeks.length - 1].value;
            selectElement.disabled = false;

        } else {
            const messageDiv = document.getElementById('checkin-message');
            showMessage(messageDiv, `週次載入失敗: ${result.message}。請確認Apps Script已發布新版本。`, 'error');
        }
    }

    // --- [功能 1/2] 學生簽到處理 ---
    document.getElementById('checkin-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const studentId = document.getElementById('student-id-input').value.trim();
        const selectedWeek = document.getElementById('week-select').value;
        const messageDiv = document.getElementById('checkin-message');
        const submitBtn = this.querySelector('button[type="submit"]');

        submitBtn.disabled = true;
        submitBtn.textContent = '簽到中...';
        
        const result = await callAppsScript('processAttendance', { 
            studentId: studentId, 
            selectedWeek: selectedWeek,
            messageDiv: messageDiv
        });
        
        showMessage(messageDiv, result.message, result.status);
        if (result.status === 'success') {
            document.getElementById('student-id-input').value = ''; // 清空學號欄位
        }
        
        submitBtn.disabled = false;
        submitBtn.textContent = '確認簽到';
    });

    // --- [功能 2] 學生查詢記錄 ---
    document.getElementById('student-query-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const studentId = document.getElementById('query-student-id').value.trim();
        const messageDiv = document.getElementById('student-query-message');
        const displayDiv = document.getElementById('student-records-display');
        const submitBtn = this.querySelector('button[type="submit"]');
        
        submitBtn.disabled = true;
        displayDiv.innerHTML = '載入中...';
        
        const result = await callAppsScript('studentQuery', { 
            studentId: studentId, 
            messageDiv: messageDiv
        });

        if (result.status === 'success') {
            showMessage(messageDiv, `${result.studentName} 同學，查到您的簽到記錄共 ${result.records.length} 筆。`, 'success');
            renderStudentRecords(result.records, displayDiv);
        } else {
            showMessage(messageDiv, result.message, 'error');
            displayDiv.innerHTML = '';
        }
        submitBtn.disabled = false;
    });

    function renderStudentRecords(records, divElement) {
        if (records.length === 0) {
             divElement.innerHTML = '<p>查無簽到記錄。</p>';
             return;
        }

        let html = '<table><thead><tr><th>週次</th><th>班級</th><th>簽到時間</th><th>完整時間戳記</th><th>狀態</th></tr></thead><tbody>';
        
        records.forEach(r => {
            // 根據 validity 判斷是否使用紅色註記
            const rowClass = r.validity === 'Invalid' ? 'class="invalid-checkin"' : '';
            const statusText = r.validity === 'Invalid' ? '非簽到時間' : '正常';
            
            html += `<tr ${rowClass}>
                <td>${r.week}</td>
                <td>${r.classId}</td>
                <td>${r.time}</td>
                <td>${r.fullTimestamp}</td>
                <td>${statusText}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        divElement.innerHTML = html;
    }


    // --- [功能 3] 教師管理介面 ---
    document.getElementById('teacher-login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const password = document.getElementById('teacher-password').value.trim();
        const messageDiv = document.getElementById('teacher-message');
        const displayDiv = document.getElementById('teacher-records-display');
        const submitBtn = this.querySelector('button[type="submit"]');
        
        submitBtn.disabled = true;
        displayDiv.innerHTML = '登入中...';
        
        const result = await callAppsScript('teacherQuery', { 
            password: password, 
            messageDiv: messageDiv
        });

        if (result.status === 'success') {
            showMessage(messageDiv, `登入成功！已載入所有 ${Object.keys(result.summary).length} 週的簽到資料。`, 'success');
            renderTeacherSummary(result.summary, displayDiv);
        } else {
            showMessage(messageDiv, result.message, 'error');
            document.getElementById('teacher-password').value = ''; 
            displayDiv.innerHTML = '';
        }
        submitBtn.disabled = false;
    });

    function renderTeacherSummary(summary, divElement) {
        let html = '';
        const weeks = Object.keys(summary).sort((a, b) => parseInt(a) - parseInt(b));

        if (weeks.length === 0) {
             divElement.innerHTML = '<p>目前沒有任何簽到記錄。</p>';
             return;
        }

        weeks.forEach(week => {
            html += `<h3>第 ${week} 週簽到狀況</h3>`;
            html += '<table><thead><tr><th>班級</th><th>學號</th><th>姓名</th><th>合法簽到次數 / 總次數</th><th>最近簽到時間 (狀態)</th></tr></thead><tbody>';
            
            const students = summary[week];
            const studentIds = Object.keys(students);

            studentIds.forEach(id => {
                const student = students[id];
                
                // 計算合法簽到次數和總次數
                const validCount = student.checkInTimes.filter(t => t.validity === 'Valid').length;
                const totalCount = student.checkInTimes.length;
                
                // 找到最晚的簽到記錄
                const latestRecord = student.checkInTimes.reduce((latest, current) => {
                    return current.fullTimestamp > latest.fullTimestamp ? current : latest;
                });
                
                // 判斷是否使用紅色註記
                const latestStatusClass = latestRecord.validity === 'Invalid' ? 'class="invalid-checkin"' : '';
                const latestStatusText = latestRecord.validity === 'Invalid' 
                                            ? `${latestRecord.fullTimestamp} (非簽到時間)` 
                                            : latestRecord.fullTimestamp;

                html += `<tr ${latestStatusClass}>
                    <td>${student.classId}</td>
                    <td>${id}</td>
                    <td>${student.studentName}</td>
                    <td>${validCount} / ${totalCount} 次</td>
                    <td>${latestStatusText}</td>
                </tr>`;
            });
            html += '</tbody></table>';
        });

        divElement.innerHTML = html;
    }


    // --- 程式啟動 ---
    document.addEventListener('DOMContentLoaded', () => {
        loadWeekOptions(); // 載入週次選單
    });

</script>

</body>
</html>
