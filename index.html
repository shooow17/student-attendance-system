<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç·šä¸Šç°½åˆ°ç³»çµ±</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f7fafc;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .tab.active {
            background: #4299e1;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .full-width-button {
            width: 100%;
            padding: 10px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .full-width-button:hover {
            background: #3182ce;
        }
        .message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .message.success {
            background: #c6f6d5;
            color: #22543d;
        }
        .message.error {
            background: #fed7d7;
            color: #742a2a;
        }
        .week-selector-container {
            margin-bottom: 20px;
        }
        .week-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .week-dropdown {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #cbd5e0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        th {
            background: #edf2f7;
        }
        .action-buttons button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .action-buttons .delete {
            background: #e53e3e;
            color: white;
        }
        .action-buttons .delete:hover {
            background: #c53030;
        }
        #changePasswordForm {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: #edf2f7;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #333;">å­¸ç”Ÿç·šä¸Šç°½åˆ°ç³»çµ±</h1>
    
    <!-- æ¨™ç±¤åˆ‡æ› -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('studentTab')">å­¸ç”Ÿç°½åˆ°</div>
        <div class="tab" onclick="switchTab('queryTab')">æŸ¥è©¢ç°½åˆ°</div>
        <div class="tab" onclick="switchTab('teacherTab')">æ•™å¸«ç®¡ç†</div>
    </div>
    
    <!-- å­¸ç”Ÿç°½åˆ°ä»‹é¢ -->
    <div id="studentTab" class="tab-content active">
        <div class="form-group">
            <label for="studentId">å­¸è™Ÿï¼š</label>
            <input type="text" id="studentId" placeholder="è¼¸å…¥æ‚¨çš„å­¸è™Ÿ">
        </div>
        <button class="full-width-button" onclick="studentSignIn()">ç°½åˆ°</button>
        <div id="signinMessage" class="message"></div>
    </div>
    
    <!-- æŸ¥è©¢ç°½åˆ°ä»‹é¢ -->
    <div id="queryTab" class="tab-content">
        <div class="form-group">
            <label for="queryStudentId">å­¸è™Ÿï¼š</label>
            <input type="text" id="queryStudentId" placeholder="è¼¸å…¥å­¸è™ŸæŸ¥è©¢ç°½åˆ°è¨˜éŒ„">
        </div>
        <button class="full-width-button" onclick="querySignIn()">æŸ¥è©¢</button>
        <div id="queryMessage" class="message"></div>
        <div id="queryResult"></div>
    </div>
    
    <!-- æ•™å¸«ç®¡ç†ä»‹é¢ -->
    <div id="teacherTab" class="tab-content">
        <!-- ç™»å…¥ä»‹é¢ -->
        <div id="teacherLogin" class="login-panel">
            <h2 style="text-align: center; margin-bottom: 20px; color: #333;">æ•™å¸«ç™»å…¥</h2>
            <div id="loginMessage"></div>
            <div class="form-group">
                <label for="teacherPassword">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š</label>
                <input type="password" id="teacherPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="full-width-button" onclick="teacherLogin()">ç™»å…¥</button>
        </div>
        
        <!-- ç®¡ç†ä»‹é¢ -->
        <div id="teacherDashboard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                <h2 style="color: #333;">ç°½åˆ°ç®¡ç†ç³»çµ±</h2>
                <div>
                    <button class="action-buttons" onclick="showChangePasswordForm()" style="background: #4299e1; margin-right: 10px;">ä¿®æ”¹å¯†ç¢¼</button>
                    <button class="action-buttons" onclick="teacherLogout()" style="background: #718096;">ç™»å‡º</button>
                </div>
            </div>
            
            <!-- ä¿®æ”¹å¯†ç¢¼è¡¨å–® -->
            <div id="changePasswordForm" style="display: none;">
                <h3 style="text-align: center; margin-bottom: 20px; color: #333;">ä¿®æ”¹æ•™å¸«å¯†ç¢¼</h3>
                <div id="changePasswordMessage" class="message"></div>
                <div class="form-group">
                    <label for="oldPassword">èˆŠå¯†ç¢¼ï¼š</label>
                    <input type="password" id="oldPassword" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼">
                </div>
                <div class="form-group">
                    <label for="newPassword">æ–°å¯†ç¢¼ï¼ˆè‡³å°‘8å€‹å­—ç¬¦ï¼‰ï¼š</label>
                    <input type="password" id="newPassword" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">ç¢ºèªæ–°å¯†ç¢¼ï¼š</label>
                    <input type="password" id="confirmNewPassword" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                </div>
                <button class="full-width-button" onclick="changeTeacherPassword()">ç¢ºèªä¿®æ”¹</button>
                <button class="full-width-button" onclick="hideChangePasswordForm()" style="background: #718096; margin-top: 10px;">å–æ¶ˆ</button>
            </div>
            
            <!-- é€±æ¬¡é¸æ“‡èˆ‡ç®¡ç†åŠŸèƒ½ -->
            <div class="week-selector-container">
                <div class="week-selector">
                    <label style="margin: 0; font-size: 16px; color: #333;">é¸æ“‡é€±æ¬¡ï¼š</label>
                    <select id="weekDropdown" class="week-dropdown" onchange="changeWeekByDropdown()">
                        <!-- é€±æ¬¡é¸é …æœƒå‹•æ…‹ç”Ÿæˆ -->
                    </select>
                    <button onclick="refreshData()" style="padding: 8px 16px; font-size: 14px;">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
            </div>
            <div id="attendanceTable"></div>
            <div style="margin-top: 20px;">
                <button class="full-width-button" onclick="clearWeek()" style="background: #e53e3e; margin-bottom: 10px;">æ¸…é™¤æœ¬é€±è³‡æ–™</button>
                <button class="full-width-button" onclick="clearAll()" style="background: #e53e3e;">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'æ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€'; // è«‹æ›¿æ›ç‚ºå¯¦éš›éƒ¨ç½²ç¶²å€
        let teacherToken = null;
        let csrfToken = null;
        let isTeacherLoggedIn = false;
        let currentViewWeek = null;
        const students = []; // å­¸ç”Ÿæ¸…å–®ç”±å¾Œç«¯æä¾›
        
        // åˆå§‹åŒ– CSRF token
        async function initCsrfToken() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getCsrfToken`);
                const result = await response.json();
                if (result.success) {
                    csrfToken = result.token;
                } else {
                    showMessage('signinMessage', 'ç„¡æ³•ç²å– CSRF token', 'error');
                }
            } catch (error) {
                showMessage('signinMessage', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                logError(error.message);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = async () => {
            await initCsrfToken();
            updateWeekDropdown();
        };
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(elementId, message, type) {
            const messageDiv = document.getElementById(elementId);
            if (messageDiv) {
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = '';
                }, 3000);
            }
        }
        
        // è¨˜éŒ„éŒ¯èª¤
        async function logError(message) {
            if (!csrfToken) return;
            try {
                const data = {
                    action: 'logError',
                    message: message,
                    csrfToken: csrfToken
                };
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (err) {
                console.error('è¨˜éŒ„éŒ¯èª¤å¤±æ•—');
            }
        }
        
        // åˆ‡æ›æ¨™ç±¤
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        }
        
        // é©—è­‰å­¸è™Ÿæ ¼å¼
        function validateStudentId(id) {
            const regex = /^[a-zA-Z0-9]{9,10}$/;
            return regex.test(id);
        }
        
        // å­¸ç”Ÿç°½åˆ°
        async function studentSignIn(override = false) {
            const studentIdInput = document.getElementById('studentId').value.trim();
            if (!validateStudentId(studentIdInput)) {
                showMessage('signinMessage', 'å­¸è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆå­¸è™Ÿ', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=validateStudent&studentId=${encodeURIComponent(studentIdInput)}`);
                const result = await response.json();
                if (!result.success) {
                    showMessage('signinMessage', result.message || 'æŸ¥ç„¡æ­¤å­¸è™Ÿ', 'error');
                    return;
                }
                
                const student = result.student;
                const data = {
                    action: 'signin',
                    week: currentViewWeek || '1',
                    studentClass: student.class,
                    studentId: student.id,
                    studentName: student.name,
                    override: override,
                    isOnTime: checkSigninTime(),
                    csrfToken: csrfToken
                };
                
                const signInResponse = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const signInResult = await signInResponse.json();
                
                if (signInResult.success) {
                    showMessage('signinMessage', signInResult.message, 'success');
                    document.getElementById('studentId').value = '';
                } else {
                    showMessage('signinMessage', signInResult.message || 'ç°½åˆ°å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('signinMessage', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                logError(error.message);
            }
        }
        
        // æª¢æŸ¥ç°½åˆ°æ™‚é–“ï¼ˆå‡è¨­æº–æ™‚ç‚ºç•¶å¤© 8:00-9:00ï¼‰
        function checkSigninTime() {
            const now = new Date();
            const hours = now.getHours();
            return hours >= 8 && hours < 9;
        }
        
        // æŸ¥è©¢ç°½åˆ°è¨˜éŒ„
        async function querySignIn() {
            const studentId = document.getElementById('queryStudentId').value.trim();
            if (!validateStudentId(studentId)) {
                showMessage('queryMessage', 'å­¸è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆå­¸è™Ÿ', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=query&studentId=${encodeURIComponent(studentId)}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <tr>
                            <th>é€±æ¬¡</th>
                            <th>ç­ç´š</th>
                            <th>å­¸è™Ÿ</th>
                            <th>å§“å</th>
                            <th>ç°½åˆ°æ™‚é–“</th>
                            <th>æ˜¯å¦æº–æ™‚</th>
                        </tr>
                    `;
                    result.data.forEach(record => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.week}</td>
                            <td>${record.studentClass}</td>
                            <td>${record.studentId}</td>
                            <td>${record.studentName}</td>
                            <td>${record.dateTime}</td>
                            <td>${record.isOnTime ? 'æ˜¯' : 'å¦'}</td>
                        `;
                        table.appendChild(row);
                    });
                    document.getElementById('queryResult').innerHTML = '';
                    document.getElementById('queryResult').appendChild(table);
                    showMessage('queryMessage', 'æŸ¥è©¢æˆåŠŸ', 'success');
                } else {
                    document.getElementById('queryResult').innerHTML = '';
                    showMessage('queryMessage', result.message || 'ç„¡ç°½åˆ°è¨˜éŒ„', 'error');
                }
            } catch (error) {
                showMessage('queryMessage', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                logError(error.message);
            }
        }
        
        // æ•™å¸«ç™»å…¥
        async function teacherLogin() {
            const password = document.getElementById('teacherPassword').value;
            if (!password) {
                showMessage('loginMessage', 'è«‹è¼¸å…¥å¯†ç¢¼', 'error');
                return;
            }
            
            try {
                const data = {
                    action: 'teacherLogin',
                    password: password,
                    csrfToken: csrfToken
                };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    teacherToken = result.token;
                    isTeacherLoggedIn = true;
                    document.getElementById('teacherLogin').style.display = 'none';
                    document.getElementById('teacherDashboard').style.display = 'block';
                    document.getElementById('teacherPassword').value = '';
                    showMessage('loginMessage', 'ç™»å…¥æˆåŠŸ', 'success');
                    refreshData();
                } else {
                    showMessage('loginMessage', result.message || 'ç™»å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                logError(error.message);
            }
        }
        
        // æ•™å¸«ç™»å‡º
        function teacherLogout() {
            teacherToken = null;
            isTeacherLoggedIn = false;
            document.getElementById('teacherDashboard').style.display = 'none';
            document.getElementById('teacherLogin').style.display = 'block';
            document.getElementById('attendanceTable').innerHTML = '';
            hideChangePasswordForm();
            showMessage('loginMessage', 'å·²ç™»å‡º', 'success');
        }
        
        // é¡¯ç¤ºä¿®æ”¹å¯†ç¢¼è¡¨å–®
        function showChangePasswordForm() {
            document.getElementById('changePasswordForm').style.display = 'block';
            document.getElementById('teacherDashboard').querySelectorAll(':not(#changePasswordForm)').forEach(el => {
                el.style.opacity = '0.5';
                el.style.pointerEvents = 'none';
            });
        }
        
        // éš±è—ä¿®æ”¹å¯†ç¢¼è¡¨å–®
        function hideChangePasswordForm() {
            document.getElementById('changePasswordForm').style.display = 'none';
            document.getElementById('teacherDashboard').querySelectorAll(':not(#changePasswordForm)').forEach(el => {
                el.style.opacity = '1';
                el.style.pointerEvents = 'auto';
            });
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('changePasswordMessage').textContent = '';
        }
        
        // ä¿®æ”¹æ•™å¸«å¯†ç¢¼
        async function changeTeacherPassword() {
            if (!teacherToken || !csrfToken) {
                showMessage('changePasswordMessage', 'æœªç™»å…¥ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
                return teacherLogout();
            }
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showMessage('changePasswordMessage', 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showMessage('changePasswordMessage', 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showMessage('changePasswordMessage', 'æ–°å¯†ç¢¼éœ€è‡³å°‘8å€‹å­—ç¬¦', 'error');
                return;
            }
            
            try {
                const data = {
                    action: 'updateTeacherPassword',
                    oldPassword: oldPassword,
                    newPassword: newPassword,
                    token: teacherToken,
                    csrfToken: csrfToken
                };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('changePasswordMessage', result.message, 'success');
                    setTimeout(() => {
                        teacherLogout();
                    }, 2000);
                } else {
                    showMessage('changePasswordMessage', result.message || 'å¯†ç¢¼æ›´æ–°å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('changePasswordMessage', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                logError(error.message);
            }
        }
        
        // æ›´æ–°é€±æ¬¡ä¸‹æ‹‰é¸å–®
        function updateWeekDropdown() {
            const dropdown = document.getElementById('weekDropdown');
            dropdown.innerHTML = '';
            for (let i = 1; i <= 18; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = `ç¬¬ ${i} é€±`;
                dropdown.appendChild(option);
            }
            currentViewWeek = dropdown.value;
        }
        
        // åˆ‡æ›é€±æ¬¡
        function changeWeekByDropdown() {
            currentViewWeek = document.getElementById('weekDropdown').value;
            refreshData();
        }
        
        // åˆ·æ–°ç°½åˆ°è³‡æ–™
        async function refreshData() {
            if (!teacherToken || !csrfToken) {
                return teacherLogout();
            }
            
            try {
                const data = {
                    action: 'getAll',
                    week: currentViewWeek,
                    token: teacherToken,
                    csrfToken: csrfToken
                };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    students.length = 0;
                    students.push(...result.students);
                    updateAttendanceTable(result.data);
                } else {
                    showMessage('loginMessage', result.message || 'ç„¡æ³•ç²å–è³‡æ–™', 'error');
                    teacherLogout();
                }
            } catch (error) {
                showMessage('loginMessage', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                logError(error.message);
                teacherLogout();
            }
        }
        
        // æ›´æ–°ç°½åˆ°è¡¨æ ¼
        function updateAttendanceTable(data) {
            const table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>é€±æ¬¡</th>
                    <th>ç­ç´š</th>
                    <th>å­¸è™Ÿ</th>
                    <th>å§“å</th>
                    <th>ç°½åˆ°æ™‚é–“</th>
                    <th>æ˜¯å¦æº–æ™‚</th>
                    <th>æ“ä½œ</th>
                </tr>
            `;
            data.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.week}</td>
                    <td>${record.studentClass}</td>
                    <td>${record.studentId}</td>
                    <td>${record.studentName}</td>
                    <td>${record.dateTime}</td>
                    <td>${record.isOnTime ? 'æ˜¯' : 'å¦'}</td>
                    <td class="action-buttons">
                        <button class="delete" onclick="deleteAttendance('${record.studentId}', '${record.week}')">åˆªé™¤</button>
                    </td>
                `;
                table.appendChild(row);
            });
            document.getElementById('attendanceTable').innerHTML = '';
            document.getElementById('attendanceTable').appendChild(table);
        }
        
        // åˆªé™¤ç°½åˆ°è¨˜éŒ„
        async function deleteAttendance(studentId, week) {
            if (!teacherToken || !csrfToken) {
                return teacherLogout();
            }
            
            try {
                const data = {
                    action: 'delete',
                    studentId: studentId,
                    week: week,
                    token: teacherToken,
                    csrfToken: csrfToken
                };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('loginMessage', result.message, 'success');
                    refreshData();
                } else {
                    showMessage('loginMessage', result.message || 'åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                logError(error.message);
            }
        }
        
        // æ¸…é™¤æœ¬é€±è³‡æ–™
        async function clearWeek() {
            if (!teacherToken || !csrfToken) {
                return teacherLogout();
            }
            
            if (!confirm(`ç¢ºå®šè¦æ¸…é™¤ç¬¬ ${currentViewWeek} é€±çš„è³‡æ–™ï¼Ÿ`)) return;
            
            try {
                const data = {
                    action: 'clearWeek',
                    week: currentViewWeek,
                    token: teacherToken,
                    csrfToken: csrfToken
                };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('loginMessage', result.message, 'success');
                    refreshData();
                } else {
                    showMessage('loginMessage', result.message || 'æ¸…é™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                logError(error.message);
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        async function clearAll() {
            if (!teacherToken || !csrfToken) {
                return teacherLogout();
            }
            
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç°½åˆ°è³‡æ–™ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ï¼')) return;
            
            try {
                const data = {
                    action: 'clearAll',
                    token: teacherToken,
                    csrfToken: csrfToken
                };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('loginMessage', result.message, 'success');
                    refreshData();
                } else {
                    showMessage('loginMessage', result.message || 'æ¸…é™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                logError(error.message);
            }
        }
    </script>
</body>
</html>
