<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生數位簽到系統</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .nav-bar button { margin: 5px; padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; background-color: #e0e0e0; border-radius: 4px; }
        .nav-bar button.active { background-color: #007bff; color: white; border-color: #007bff; }
        .page { border-top: 2px solid #ccc; padding-top: 20px; margin-top: 15px; }
        h2 { color: #333; }
        input, select, button { padding: 10px; margin-top: 8px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #ccc; width: calc(100% - 22px); box-sizing: border-box;}
        button { background-color: #28a745; color: white; cursor: pointer; }
        button:hover { background-color: #218838; }
        .message { padding: 10px; margin-top: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

<div class="container">
    <h1>學生數位簽到系統</h1>
    <div class="nav-bar">
        <button id="show-checkin-btn" class="active">學生簽到</button>
        <button id="show-student-query-btn">學生查詢</button>
        <button id="show-teacher-admin-btn">教師管理</button>
    </div>

    <div id="checkin-page" class="page">
        <h2>學生簽到</h2>
        <form id="checkin-form">
            <label for="week-select">選擇週次：</label>
            <select id="week-select" required></select>
            
            <label for="student-id-input">學號：</label>
            <input type="text" id="student-id-input" placeholder="請輸入學號" required>
            
            <button type="submit">確認簽到</button>
        </form>
        <div id="checkin-message" class="message"></div>
    </div>

    <div id="student-query-page" class="page" style="display: none;">
        <h2>查詢個人簽到記錄</h2>
        <form id="student-query-form">
            <label for="query-student-id">學號：</label>
            <input type="text" id="query-student-id" placeholder="請輸入學號" required>
            <button type="submit">查詢記錄</button>
        </form>
        <div id="student-query-message" class="message"></div>
        <div id="student-records-display"></div>
    </div>

    <div id="teacher-admin-page" class="page" style="display: none;">
        <h2>教師管理介面</h2>
        <form id="teacher-login-form">
            <label for="teacher-password">管理密碼：</label>
            <input type="password" id="teacher-password" placeholder="請輸入密碼" required>
            <button type="submit">登入並顯示記錄</button>
        </form>
        <div id="teacher-message" class="message"></div>
        <div id="teacher-records-display"></div>
    </div>

</div>

<script>
    // 請將這個 URL 替換為您重新部署 Apps Script 後得到的「網頁應用程式」URL
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwyx1NW8ZEsoqlMH2pq2-4IVuYoHlm33dW8v2SyxS21M8P07KftPLBvkMI5GnuX03xC_w/exec'; 
    
    // --- 頁面切換邏輯 ---
    const pages = {
        'checkin-page': document.getElementById('checkin-page'),
        'student-query-page': document.getElementById('student-query-page'),
        'teacher-admin-page': document.getElementById('teacher-admin-page')
    };
    const navButtons = {
        'show-checkin-btn': 'checkin-page',
        'show-student-query-btn': 'student-query-page',
        'show-teacher-admin-btn': 'teacher-admin-page'
    };

    function showPage(pageId) {
        for (let id in pages) {
            pages[id].style.display = (id === pageId) ? 'block' : 'none';
        }
        for (let btnId in navButtons) {
            document.getElementById(btnId).classList.toggle('active', navButtons[btnId] === pageId);
        }
    }

    document.getElementById('show-checkin-btn').addEventListener('click', () => showPage('checkin-page'));
    document.getElementById('show-student-query-btn').addEventListener('click', () => showPage('student-query-page'));
    document.getElementById('show-teacher-admin-btn').addEventListener('click', () => showPage('teacher-admin-page'));


    // --- 核心 Apps Script 通訊函數 ---
    async function callAppsScript(action, data = {}) {
        const messageDiv = data.messageDiv; // 為了顯示錯誤訊息而傳遞
        if (messageDiv) messageDiv.innerHTML = ''; 

        const formData = new URLSearchParams({ action, ...data });

        try {
            const response = await fetch(APP_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            const result = await response.json();
            return result;

        } catch (e) {
            const msg = '連線錯誤，請檢查 Apps Script URL 或網路連線。';
            if (messageDiv) showMessage(messageDiv, msg, 'error');
            return { status: 'error', message: msg };
        }
    }
    
    // --- 輔助函數：顯示訊息 ---
    function showMessage(divElement, message, type) {
        divElement.className = `message ${type}`;
        divElement.textContent = message;
    }

    // --- [功能 1] 週次選單載入 ---
    async function loadWeekOptions() {
        const selectElement = document.getElementById('week-select');
        selectElement.innerHTML = ''; // 清空舊選項
        
        const result = await callAppsScript('getWeekOptions');

        if (result.status === 'success') {
            result.weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week.value;
                option.textContent = week.label;
                selectElement.appendChild(option);
            });
            // 預設選中最後一週或當前週，這裡簡單選中最後一週
            selectElement.value = result.weeks[result.weeks.length - 1].value;

        } else {
            const messageDiv = document.getElementById('checkin-message');
            showMessage(messageDiv, `週次載入失敗: ${result.message}`, 'error');
        }
    }

    // --- [功能 1/2] 學生簽到處理 ---
    document.getElementById('checkin-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const studentId = document.getElementById('student-id-input').value.trim();
        const selectedWeek = document.getElementById('week-select').value;
        const messageDiv = document.getElementById('checkin-message');
        
        const result = await callAppsScript('processAttendance', { 
            studentId: studentId, 
            selectedWeek: selectedWeek,
            messageDiv: messageDiv
        });
        
        showMessage(messageDiv, result.message, result.status);
        if (result.status === 'success') {
            document.getElementById('student-id-input').value = ''; // 清空學號欄位
        }
    });

    // --- [功能 2] 學生查詢記錄 ---
    document.getElementById('student-query-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const studentId = document.getElementById('query-student-id').value.trim();
        const messageDiv = document.getElementById('student-query-message');
        const displayDiv = document.getElementById('student-records-display');
        displayDiv.innerHTML = '';
        
        const result = await callAppsScript('studentQuery', { 
            studentId: studentId, 
            messageDiv: messageDiv
        });

        if (result.status === 'success') {
            showMessage(messageDiv, `${result.studentName} 同學，查到您的簽到記錄共 ${result.records.length} 筆。`, 'success');
            renderStudentRecords(result.records, displayDiv);
        } else {
            showMessage(messageDiv, result.message, 'error');
        }
    });

    function renderStudentRecords(records, divElement) {
        if (records.length === 0) return;

        let html = '<table><thead><tr><th>週次</th><th>班級</th><th>簽到時間</th><th>完整時間戳記</th></tr></thead><tbody>';
        records.forEach(r => {
            html += `<tr>
                <td>${r.week}</td>
                <td>${r.classId}</td>
                <td>${r.time}</td>
                <td>${r.fullTimestamp}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        divElement.innerHTML = html;
    }


    // --- [功能 3] 教師管理介面 ---
    document.getElementById('teacher-login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const password = document.getElementById('teacher-password').value.trim();
        const messageDiv = document.getElementById('teacher-message');
        const displayDiv = document.getElementById('teacher-records-display');
        displayDiv.innerHTML = '';
        
        const result = await callAppsScript('teacherQuery', { 
            password: password, 
            messageDiv: messageDiv
        });

        if (result.status === 'success') {
            showMessage(messageDiv, `登入成功！已載入所有 ${Object.keys(result.summary).length} 週的簽到資料。`, 'success');
            renderTeacherSummary(result.summary, displayDiv);
        } else {
            showMessage(messageDiv, result.message, 'error');
            document.getElementById('teacher-password').value = ''; // 登入失敗清空密碼
        }
    });

    function renderTeacherSummary(summary, divElement) {
        let html = '';
        const weeks = Object.keys(summary).sort((a, b) => parseInt(a) - parseInt(b));

        weeks.forEach(week => {
            html += `<h3>第 ${week} 週簽到狀況</h3>`;
            html += '<table><thead><tr><th>班級</th><th>學號</th><th>姓名</th><th>簽到次數</th><th>最近簽到時間</th></tr></thead><tbody>';
            
            const students = summary[week];
            const studentIds = Object.keys(students);

            studentIds.forEach(id => {
                const student = students[id];
                const count = student.checkInTimes.length;
                
                // 找到最晚的簽到時間
                const latestTime = student.checkInTimes.reduce((latest, current) => {
                    return current.fullTimestamp > latest.fullTimestamp ? current : latest;
                });

                html += `<tr>
                    <td>${student.classId}</td>
                    <td>${id}</td>
                    <td>${student.studentName}</td>
                    <td>${count} 次</td>
                    <td>${latestTime.fullTimestamp}</td>
                </tr>`;
            });
            html += '</tbody></table>';
        });

        if (weeks.length === 0) {
            html = '<p>目前沒有任何簽到記錄。</p>';
        }

        divElement.innerHTML = html;
    }


    // --- 程式啟動 ---
    document.addEventListener('DOMContentLoaded', () => {
        loadWeekOptions();
    });

</script>

</body>
</html>
