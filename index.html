// 全域變數
const SPREADSHEET_ID = 'https://script.google.com/macros/s/AKfycbwyx1NW8ZEsoqlMH2pq2-4IVuYoHlm33dW8v2SyxS21M8P07KftPLBvkMI5GnuX03xC_w/exec';
const SS = SpreadsheetApp.openById(SPREADSHEET_ID);

// 分頁名稱常數
const STUDENTS_SHEET_NAME = 'Students';
const ATTENDANCE_SHEET_NAME = 'Attendance';
const ERROR_LOG_SHEET_NAME = 'ErrorLog';
const PS_SHEET_NAME = 'ps'; // 假設密碼儲存在此分頁的 A1

// ----------------------------------------------------
// 1. 服務部署入口 (doGet/doPost)
// ----------------------------------------------------

function doGet(e) {
  // 解決 'No HTML file named index was found' 錯誤
  return HtmlService.createTemplateFromFile('index') 
      .evaluate()
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function doPost(e) {
  const action = e.parameter.action;
  let result = {};

  try {
    switch (action) {
      case 'getWeekOptions':
        // 動作 1: 取得週次選單選項 (給前端的下拉選單用)
        result = generateWeekOptions();
        break;
      case 'processAttendance':
        // 動作 2: 學生簽到
        const attendanceData = {
          studentId: e.parameter.studentId,
          selectedWeek: parseInt(e.parameter.selectedWeek) // 取得前端傳來選定的週次
        };
        result = processAttendance(attendanceData);
        break;
      case 'studentQuery':
        // 動作 3: 學生查詢自己的簽到記錄
        result = handleStudentQuery(e.parameter.studentId);
        break;
      case 'teacherQuery':
        // 動作 4: 教師管理介面查詢
        result = handleTeacherQuery(e.parameter.password);
        break;
      default:
        result = { status: 'error', message: '無效的操作指令。' };
        break;
    }
  } catch (error) {
    const errorMessage = `doPost 系統錯誤: ${error.toString()}`;
    result = { status: 'error', message: `伺服器錯誤，請聯繫管理員。` };
    logError(errorMessage);
  }

  // 將結果以 JSON 格式返回給前端
  return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
}

// ----------------------------------------------------
// 2. 核心邏輯：功能實現
// ----------------------------------------------------

/**
 * [功能 1] 根據固定起點生成 18 週的選單選項。
 */
function generateWeekOptions() {
  // 1140920 => 2025年9月20日 (JavaScript月份從 0 開始，所以 8 是 9月)
  const startDate = new Date(2025, 8, 20); 
  const options = [];
  
  for (let i = 1; i <= 18; i++) {
    // 計算當前週的日期
    const currentDate = new Date(startDate.getTime() + (i - 1) * 7 * 24 * 60 * 60 * 1000);
    
    // 格式化為民國年 (YYY)MMDD 格式 (例如: 1140920)
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    const day = currentDate.getDate();
    
    const rocYear = year - 1911; 
    
    const formattedDate = `${rocYear}${String(month).padStart(2, '0')}${String(day).padStart(2, '0')}`;
    
    const label = `第${i}週 ${formattedDate}`;
    const value = i; // 週次號碼
    
    options.push({ label, value });
  }
  return { status: 'success', weeks: options };
}


/**
 * 處理簽到請求 (已更新為使用前端傳來的 selectedWeek)。
 */
function processAttendance(formData) {
  let result = {};
  const { studentId, selectedWeek } = formData;

  if (!studentId || isNaN(selectedWeek)) {
    result = { status: 'error', message: '學號或週次不能為空！' };
    logError(`簽到失敗: 輸入資料不完整`);
    return result;
  }

  try {
    const studentsSheet = SS.getSheetByName(STUDENTS_SHEET_NAME);
    const attendanceSheet = SS.getSheetByName(ATTENDANCE_SHEET_NAME);
    
    const studentValues = studentsSheet.getDataRange().getValues().slice(1);
    
    // 查找學生資料: [班級(0), 學號(1), 姓名(2)]
    const studentInfo = studentValues.find(row => 
        row.length >= 3 && String(row[1]).trim() === studentId 
    );

    if (!studentInfo) {
      result = { status: 'error', message: `學號 ${studentId} 不存在於學生名單中。` };
      logError(`簽到失敗: 學號 ${studentId} 不存在`);
      return result;
    }

    const [classId, retrievedStudentId, studentName] = studentInfo;
    
    // 準備簽到記錄資料
    const now = new Date();
    const attendanceTime = Utilities.formatDate(now, Session.getScriptTimeZone(), 'HH:mm:ss');
    
    // 寫入簽到記錄 [週次, 班級, 學號, 姓名, 簽到時間, 時間戳記]
    const newRow = [
      selectedWeek, // 使用選單選擇的週次
      classId,
      retrievedStudentId,
      studentName,
      attendanceTime,
      now // 寫入完整的時間戳記
    ];
    
    attendanceSheet.appendRow(newRow);

    result = { 
      status: 'success', 
      message: `${classId} 班 ${studentName} (${retrievedStudentId}) 在 第${selectedWeek}週 簽到成功！`,
      studentName: studentName // 返回姓名給前端顯示歡迎訊息
    };

  } catch (e) {
    const errorMessage = `處理簽到時發生錯誤: ${e.toString()}`;
    result = { status: 'error', message: `系統錯誤，請聯繫管理員。` };
    logError(errorMessage);
  }

  return result;
}

/**
 * [功能 2] 學生查詢自己的簽到情況。
 */
function handleStudentQuery(studentId) {
  const attendanceSheet = SS.getSheetByName(ATTENDANCE_SHEET_NAME);
  const studentsSheet = SS.getSheetByName(STUDENTS_SHEET_NAME);

  if (!attendanceSheet || !studentsSheet) {
    return { status: 'error', message: '試算表分頁遺失，請聯繫管理員。' };
  }
  
  // 檢查學號是否有效
  const studentValues = studentsSheet.getDataRange().getValues().slice(1);
  const studentInfo = studentValues.find(row => 
      row.length >= 3 && String(row[1]).trim() === studentId 
  );

  if (!studentInfo) {
      return { status: 'error', message: `學號 ${studentId} 不存在於名單中。` };
  }
  
  // 讀取所有簽到記錄
  const allRecords = attendanceSheet.getDataRange().getValues();
  if (allRecords.length <= 1) {
    return { status: 'success', records: [], message: '尚無任何簽到記錄。' };
  }
  
  const headers = allRecords[0]; 
  const data = allRecords.slice(1);
  
  // 過濾出該學生的記錄
  const studentRecords = data.filter(row => 
    row.length >= 3 && String(row[2]).trim() === studentId 
  ).map(row => {
    // 轉換時間戳記格式，方便前端顯示
    const timestamp = Utilities.formatDate(new Date(row[5]), Session.getScriptTimeZone(), 'YYYY-MM-DD HH:mm:ss');

    return {
      week: row[0],
      classId: row[1],
      time: row[4],
      fullTimestamp: timestamp
    };
  });
  
  return { 
    status: 'success', 
    records: studentRecords,
    studentName: studentInfo[2] // 姓名
  };
}

/**
 * [功能 3] 教師管理介面：查詢所有簽到狀況 (需密碼)。
 */
function handleTeacherQuery(password) {
  if (!verifyPassword(password)) {
    return { status: 'error', message: '密碼錯誤，請重新輸入。' };
  }
  
  const attendanceSheet = SS.getSheetByName(ATTENDANCE_SHEET_NAME);
  if (!attendanceSheet) {
    return { status: 'error', message: 'Attendance 分頁遺失，請聯繫管理員。' };
  }
  
  const allRecords = attendanceSheet.getDataRange().getValues();
  
  if (allRecords.length <= 1) {
    return { status: 'success', summary: {}, message: '尚無任何簽到記錄。' };
  }

  // [週次(0), 班級(1), 學號(2), 姓名(3), 簽到時間(4), 時間戳記(5)]
  const headers = allRecords[0];
  const data = allRecords.slice(1);

  // 整理資料結構： { '週次1': { '學號A': [簽到記錄1, 簽到記錄2], '學號B': [...] }, ... }
  const weeklySummary = {};
  
  data.forEach(row => {
    const week = String(row[0]).trim();
    const studentId = String(row[2]).trim();
    const time = row[4];
    const classId = row[1];
    const studentName = row[3];
    const timestamp = Utilities.formatDate(new Date(row[5]), Session.getScriptTimeZone(), 'YYYY-MM-DD HH:mm:ss');

    if (!weeklySummary[week]) {
      weeklySummary[week] = {};
    }
    
    if (!weeklySummary[week][studentId]) {
      weeklySummary[week][studentId] = {
        classId: classId,
        studentName: studentName,
        checkInTimes: []
      };
    }
    
    weeklySummary[week][studentId].checkInTimes.push({ time, fullTimestamp: timestamp });
  });

  return { status: 'success', summary: weeklySummary, headers: headers };
}

// ----------------------------------------------------
// 3. 輔助函數
// ----------------------------------------------------

/**
 * 驗證老師的管理密碼
 */
function verifyPassword(password) {
    try {
        const psSheet = SS.getSheetByName(PS_SHEET_NAME);
        if (!psSheet) {
            logError(`找不到分頁: ${PS_SHEET_NAME}`);
            // 為了避免因密碼分頁不存在而鎖定教師，可以考慮返回 true 或預設密碼
            // 這裡假設定為找不到分頁則驗證失敗
            return false;
        }

        // 假設密碼儲存在 A1
        const correctPassword = String(psSheet.getRange('A1').getValue()).trim(); 
        
        return password.trim() === correctPassword;
    } catch (e) {
        logError(`密碼驗證錯誤: ${e.toString()}`);
        return false;
    }
}

/**
 * 記錄錯誤訊息到 ErrorLog 分頁
 */
function logError(message) {
  try {
    const errorLogSheet = SS.getSheetByName(ERROR_LOG_SHEET_NAME);
    if (errorLogSheet) {
      errorLogSheet.appendRow([new Date(), message]); 
    } else {
      Logger.log(`無法記錄錯誤，找不到分頁: ${ERROR_LOG_SHEET_NAME}. 原始錯誤: ${message}`);
    }
  } catch (e) {
    Logger.log(`記錄錯誤時又發生錯誤: ${e.toString()}`);
  }
}
